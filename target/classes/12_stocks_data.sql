-- 12_stocks_data.sql
-- =====================================================
-- 0. UNIQUE KEY 제약조건 추가 (중복 데이터 방지)
-- =====================================================

-- material_stocks 테이블에 (material_id, branch_id) 조합으로 UNIQUE KEY 추가
-- 이미 존재하는 경우 무시
ALTER TABLE material_stocks 
ADD UNIQUE KEY uk_material_branch (material_id, branch_id);

-- =====================================================
-- 1. 지점별 재고 데이터 삽입 (INSERT IGNORE 사용)
-- =====================================================

INSERT IGNORE INTO material_stocks (material_id, branch_id, current_stock, min_stock, max_stock, reserved_stock, available_stock, last_updated, created_at) VALUES
-- 강남점(1) 재고 - 높은 매출로 재고 소진 빠름
(1, 1, 120, 30, 500, 20, 100, NOW(), NOW()),
(2, 1, 1500, 2000, 8000, 500, 1000, NOW(), NOW()),
(3, 1, 1200, 1500, 6000, 300, 900, NOW(), NOW()),
(4, 1, 6000, 3000, 12000, 0, 6000, NOW(), NOW()),
(5, 1, 1500, 2000, 8000, 500, 1000, NOW(), NOW()),
(6, 1, 1200, 1500, 6000, 300, 900, NOW(), NOW()),
(7, 1, 6000, 3000, 12000, 0, 6000, NOW(), NOW()),
(8, 1, 800, 1000, 4000, 200, 600, NOW(), NOW()),
(9, 1, 400, 200, 2000, 100, 300, NOW(), NOW()),
(10, 1, 100, 150, 600, 50, 50, NOW(), NOW()),
(11, 1, 3000, 4000, 12000, 1000, 2000, NOW(), NOW()),
(12, 1, 2000, 3000, 8000, 500, 1500, NOW(), NOW()),
(13, 1, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(14, 1, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(15, 1, 8000, 5000, 25000, 2000, 6000, NOW(), NOW()),
(16, 1, 300, 300, 1500, 50, 250, NOW(), NOW()),
(17, 1, 3000, 2000, 10000, 500, 2500, NOW(), NOW()),
(18, 1, 6000, 5000, 15000, 1000, 5000, NOW(), NOW()),
(19, 1, 4000, 4000, 12000, 500, 3500, NOW(), NOW()),
(20, 1, 20, 30, 80, 10, 10, NOW(), NOW()),
(21, 1, 5000, 5000, 15000, 1000, 4000, NOW(), NOW()),
(22, 1, 4000, 4000, 12000, 500, 3500, NOW(), NOW()),
(23, 1, 2000, 3000, 8000, 500, 1500, NOW(), NOW()),
(24, 1, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(25, 1, 4000, 4000, 12000, 500, 3500, NOW(), NOW()),
(26, 1, 2000, 3000, 8000, 500, 1500, NOW(), NOW()),
(27, 1, 2000, 3000, 8000, 500, 1500, NOW(), NOW()),

-- 홍대점(2) 재고 - 적정 수준 유지
(1, 2, 300, 30, 500, 50, 250, NOW(), NOW()),
(2, 2, 4000, 2000, 8000, 0, 4000, NOW(), NOW()),
(3, 2, 3000, 1500, 6000, 0, 3000, NOW(), NOW()),
(4, 2, 8000, 3000, 12000, 0, 8000, NOW(), NOW()),
(5, 2, 4000, 2000, 8000, 0, 4000, NOW(), NOW()),
(6, 2, 3000, 1500, 6000, 0, 3000, NOW(), NOW()),
(7, 2, 8000, 3000, 12000, 0, 8000, NOW(), NOW()),
(8, 2, 2000, 1000, 4000, 0, 2000, NOW(), NOW()),
(9, 2, 1000, 200, 2000, 0, 1000, NOW(), NOW()),
(10, 2, 300, 150, 600, 0, 300, NOW(), NOW()),
(11, 2, 6000, 4000, 12000, 0, 6000, NOW(), NOW()),
(12, 2, 4000, 3000, 8000, 0, 4000, NOW(), NOW()),
(13, 2, 10000, 5000, 15000, 0, 10000, NOW(), NOW()),
(14, 2, 10000, 5000, 15000, 0, 10000, NOW(), NOW()),
(15, 2, 15000, 5000, 25000, 0, 15000, NOW(), NOW()),
(16, 2, 800, 300, 1500, 0, 800, NOW(), NOW()),
(17, 2, 6000, 2000, 10000, 0, 6000, NOW(), NOW()),
(18, 2, 10000, 5000, 15000, 0, 10000, NOW(), NOW()),
(19, 2, 8000, 4000, 12000, 0, 8000, NOW(), NOW()),
(20, 2, 50, 30, 80, 0, 50, NOW(), NOW()),
(21, 2, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(22, 2, 6000, 4000, 12000, 0, 6000, NOW(), NOW()),
(23, 2, 4000, 3000, 8000, 0, 4000, NOW(), NOW()),
(24, 2, 10000, 5000, 15000, 0, 10000, NOW(), NOW()),
(25, 2, 6000, 4000, 12000, 0, 6000, NOW(), NOW()),
(26, 2, 4000, 3000, 8000, 0, 4000, NOW(), NOW()),
(27, 2, 4000, 3000, 8000, 0, 4000, NOW(), NOW()),

-- 신촌점(3) 재고 - 신규 오픈으로 재고 충분
(1, 3, 400, 30, 500, 0, 400, NOW(), NOW()),
(2, 3, 6000, 2000, 8000, 0, 6000, NOW(), NOW()),
(3, 3, 4500, 1500, 6000, 0, 4500, NOW(), NOW()),
(4, 3, 10000, 3000, 12000, 0, 10000, NOW(), NOW()),
(5, 3, 6000, 2000, 8000, 0, 6000, NOW(), NOW()),
(6, 3, 4500, 1500, 6000, 0, 4500, NOW(), NOW()),
(7, 3, 10000, 3000, 12000, 0, 10000, NOW(), NOW()),
(8, 3, 3000, 1000, 4000, 0, 3000, NOW(), NOW()),
(9, 3, 1500, 200, 2000, 0, 1500, NOW(), NOW()),
(10, 3, 450, 150, 600, 0, 450, NOW(), NOW()),
(11, 3, 9000, 4000, 12000, 0, 9000, NOW(), NOW()),
(12, 3, 6000, 3000, 8000, 0, 6000, NOW(), NOW()),
(13, 3, 12000, 5000, 15000, 0, 12000, NOW(), NOW()),
(14, 3, 12000, 5000, 15000, 0, 12000, NOW(), NOW()),
(15, 3, 20000, 5000, 25000, 0, 20000, NOW(), NOW()),
(16, 3, 1200, 300, 1500, 0, 1200, NOW(), NOW()),
(17, 3, 8000, 2000, 10000, 0, 8000, NOW(), NOW()),
(18, 3, 12000, 5000, 15000, 0, 12000, NOW(), NOW()),
(19, 3, 10000, 4000, 12000, 0, 10000, NOW(), NOW()),
(20, 3, 70, 30, 80, 0, 70, NOW(), NOW()),
(21, 3, 12000, 5000, 15000, 0, 12000, NOW(), NOW()),
(22, 3, 9000, 4000, 12000, 0, 9000, NOW(), NOW()),
(23, 3, 6000, 3000, 8000, 0, 6000, NOW(), NOW()),
(24, 3, 12000, 5000, 15000, 0, 12000, NOW(), NOW()),
(25, 3, 9000, 4000, 12000, 0, 9000, NOW(), NOW()),
(26, 3, 6000, 3000, 8000, 0, 6000, NOW(), NOW()),
(27, 3, 6000, 3000, 8000, 0, 6000, NOW(), NOW()),

-- 잠실점(4) 재고 - 중간 수준
(1, 4, 250, 30, 500, 30, 220, NOW(), NOW()),
(2, 4, 3500, 2000, 8000, 0, 3500, NOW(), NOW()),
(3, 4, 2500, 1500, 6000, 0, 2500, NOW(), NOW()),
(4, 4, 7000, 3000, 12000, 0, 7000, NOW(), NOW()),
(5, 4, 3500, 2000, 8000, 0, 3500, NOW(), NOW()),
(6, 4, 2500, 1500, 6000, 0, 2500, NOW(), NOW()),
(7, 4, 7000, 3000, 12000, 0, 7000, NOW(), NOW()),
(8, 4, 1500, 1000, 4000, 0, 1500, NOW(), NOW()),
(9, 4, 800, 200, 2000, 0, 800, NOW(), NOW()),
(10, 4, 200, 150, 600, 0, 200, NOW(), NOW()),
(11, 4, 5000, 4000, 12000, 0, 5000, NOW(), NOW()),
(12, 4, 3500, 3000, 8000, 0, 3500, NOW(), NOW()),
(13, 4, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(14, 4, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(15, 4, 12000, 5000, 25000, 0, 12000, NOW(), NOW()),
(16, 4, 600, 300, 1500, 0, 600, NOW(), NOW()),
(17, 4, 5000, 2000, 10000, 0, 5000, NOW(), NOW()),
(18, 4, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(19, 4, 6000, 4000, 12000, 0, 6000, NOW(), NOW()),
(20, 4, 40, 30, 80, 0, 40, NOW(), NOW()),
(21, 4, 7000, 5000, 15000, 0, 7000, NOW(), NOW()),
(22, 4, 5000, 4000, 12000, 0, 5000, NOW(), NOW()),
(23, 4, 3000, 3000, 8000, 0, 3000, NOW(), NOW()),
(24, 4, 8000, 5000, 15000, 0, 8000, NOW(), NOW()),
(25, 4, 5000, 4000, 12000, 0, 5000, NOW(), NOW()),
(26, 4, 3000, 3000, 8000, 0, 3000, NOW(), NOW()),
(27, 4, 3000, 3000, 8000, 0, 3000, NOW(), NOW()),

-- 송파점(5) 재고 - 신규 오픈으로 재고 충분
(1, 5, 450, 30, 500, 0, 450, NOW(), NOW()),
(2, 5, 7000, 2000, 8000, 0, 7000, NOW(), NOW()),
(3, 5, 5000, 1500, 6000, 0, 5000, NOW(), NOW()),
(4, 5, 11000, 3000, 12000, 0, 11000, NOW(), NOW()),
(5, 5, 7000, 2000, 8000, 0, 7000, NOW(), NOW()),
(6, 5, 5000, 1500, 6000, 0, 5000, NOW(), NOW()),
(7, 5, 11000, 3000, 12000, 0, 11000, NOW(), NOW()),
(8, 5, 3500, 1000, 4000, 0, 3500, NOW(), NOW()),
(9, 5, 1800, 200, 2000, 0, 1800, NOW(), NOW()),
(10, 5, 500, 150, 600, 0, 500, NOW(), NOW()),
(11, 5, 11000, 4000, 12000, 0, 11000, NOW(), NOW()),
(12, 5, 7000, 3000, 8000, 0, 7000, NOW(), NOW()),
(13, 5, 13000, 5000, 15000, 0, 13000, NOW(), NOW()),
(14, 5, 13000, 5000, 15000, 0, 13000, NOW(), NOW()),
(15, 5, 22000, 5000, 25000, 0, 22000, NOW(), NOW()),
(16, 5, 1400, 300, 1500, 0, 1400, NOW(), NOW()),
(17, 5, 9000, 2000, 10000, 0, 9000, NOW(), NOW()),
(18, 5, 13000, 5000, 15000, 0, 13000, NOW(), NOW()),
(19, 5, 11000, 4000, 12000, 0, 11000, NOW(), NOW()),
(20, 5, 75, 30, 80, 0, 75, NOW(), NOW()),
(21, 5, 13000, 5000, 15000, 0, 13000, NOW(), NOW()),
(22, 5, 10000, 4000, 12000, 0, 10000, NOW(), NOW()),
(23, 5, 7000, 3000, 8000, 0, 7000, NOW(), NOW()),
(24, 5, 13000, 5000, 15000, 0, 13000, NOW(), NOW()),
(25, 5, 10000, 4000, 12000, 0, 10000, NOW(), NOW()),
(26, 5, 7000, 3000, 8000, 0, 7000, NOW(), NOW()),
(27, 5, 7000, 3000, 8000, 0, 7000, NOW(), NOW());

-- =====================================================
-- 2. 재고 데이터 확인 쿼리
-- =====================================================

-- 지점별 재고 현황 요약
SELECT 
    b.branch_name,
    COUNT(ms.id) as total_materials,
    COUNT(CASE WHEN ms.current_stock <= ms.min_stock THEN 1 END) as low_stock_count,
    COUNT(CASE WHEN ms.current_stock >= (ms.max_stock * 0.8) THEN 1 END) as excess_stock_count,
    SUM(ms.current_stock * m.cost_per_unit) as total_inventory_value
FROM branches b
LEFT JOIN material_stocks ms ON b.id = ms.branch_id
LEFT JOIN materials m ON ms.material_id = m.id
WHERE b.branch_type = 'branch'
GROUP BY b.id, b.branch_name
ORDER BY b.id;

-- 재고 부족 항목 조회
SELECT 
    b.branch_name,
    m.name as material_name,
    m.category,
    ms.current_stock,
    ms.min_stock,
    ms.max_stock,
    ms.unit,
    ROUND((ms.current_stock / ms.min_stock) * 100, 1) as stock_ratio
FROM material_stocks ms
JOIN branches b ON ms.branch_id = b.id
JOIN materials m ON ms.material_id = m.id
WHERE ms.current_stock <= ms.min_stock
ORDER BY b.branch_name, stock_ratio ASC;